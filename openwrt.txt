====== OpenWrt ======

==Multiple Access Points per radios (Multiple SSID's)==
http://trac.gateworks.com/wiki/OpenWrt/wireless/access_point

==replace dropbear by openssh-server==
http://wiki.openwrt.org/inbox/replacingdropbearbyopensshserver

==ubus==
Accessing utilities like iwinfo through ubus might also be interesting, see: 
http://wiki.openwrt.org/doc/techref/ubus#lua_module_for_ubus
https://forum.openwrt.org/viewtopic.php?id=57554

De nieuwe Luci (LuCI2) lijkt ook ubus over http te gebruiken? 
http://wiki.openwrt.org/doc/techref/luci2
http://wiki.openwrt.org/doc/techref/ubus#access_to_ubus_over_http

==steps to get started with extroot==
* flash the wifibox with a regular OpenWrt image
* connect an ethernet cable between the wifibox and your computer
* setup your computer's ethernet interface to 192.168.1.2/24 (/24 means subnetmask 255.255.255.0)
* `telnet to 192.168.1.1`
* set a password with `passwd` to enable ssh
* exit telnet
* `ssh root@192.168.1.1`
* `vi /etc/config/network`
* optional: choose another static ipaddress for the LAN connection (for example 192.168.5.1)
* add an interface for wlan setting the protocol to dhcp:  
```
  config interface 'wlan'
    option proto 'dhcp'
```
* exit vi (`ESC`, `:`, `w`, `q`)
* `vi /etc/config/wireless`
* remove the `disabled` option (in vi use `dd` to remove a line)
* add the `country` option and set to `NL` (or other country code) (don't know why this is needed but otherwise 'Network is unreachable')
* change the `mode` of the wifi-iface to 'sta' (to become a WiFi client/station instead of an accesspoint)
* change the wifi-iface `network` to `wlan`
* set the `ssid` option to that of your home WiFi network.
* set the `key` to your network's password.
* choose the right `encryption` for example `psk2`.
* exit vi
* `reboot`
* set your computer's ethernet interface to receive a DHCP address.
* connect with ssh
* update the packages list: `opkg update`
* `opkg install block-mount kmod-usb-storage kmod-fs-ext4`
* on your computer setup a ext3 or ext4 filesystem on a USB drive
<code>
diskutil list
diskutil unmount /dev/disk#s#
mkfs.ext4 /dev/disk#s#
</code>
follow more steps on https://www.loganmarchione.com/2014/10/openwrt-with-openvpn-client-on-tp-link-tl-mr3020/

==a5v11==
* http://wiki.openwrt.org/toh/unbranded/a5-v11

=='bordjes'==
* https://www.kickstarter.com/projects/706167548/dominoio-an-open-hardware-wifi-platform-for-things
* https://www.kickstarter.com/projects/1133560316/black-swift-tiny-wireless-computer/
* https://www.kickstarter.com/projects/onion/onion-omega-invention-platform-for-the-internet-of?ref=category
* Ook interessant is die Node.js port van Tessel (http://tessel.io/). Ben benieuwd of we daarmee dingen zoals socket.io kunnen doen zonder USB stick. Same goes for Espruino (http://www.espruino.com), zie:
https://forum.openwrt.org/viewtopic.php?pid=264395#p264395
* http://sodaq.com/ (arduino based)

==packages==
* http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/packages/base/
* [[http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/packages/base/libpthread_0.9.33.2-1_ar71xx.ipk|libpthread]]
* [[http://downloads.openwrt.org/barrier_breaker/14.07/ar71xx/generic/packages/base/librt_0.9.33.2-1_ar71xx.ipk|librt]]

==image generator==
* http://wiki.openwrt.org/doc/howto/obtain.firmware.generate

==extroot==
* http://wiki.openwrt.org/doc/howto/extroot

==fstab==
* http://wiki.openwrt.org/doc/uci/fstab

==boot from USB==
* http://www.loganmarchione.com/2014/10/openwrt-with-openvpn-client-on-tp-link-tl-mr3020/

==list installed packages==
  opkg list

==make & scp & sysupgrade==
  make
  scp /Volumes/OpenWRT/trunk/bin/ar71xx/openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-sysupgrade.bin wifibox:/tmp
  ssh wifibox sysupgrade -v -n /tmp/openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-sysupgrade.bin
  
oneliner: cat & make & scp & ssh sysupgrade
  cat ~/.ssh/id_rsa.pub | ssh wifibox 'cat >> /etc/dropbear/authorized_keys' && make V=s && scp /Volumes/OpenWRT/trunk/bin/ar71xx/openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-factory.bin wifibox:/tmp && ssh wifibox sysupgrade -n -v /tmp/openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-factory.bin

==add public key to authorized_keys on openwrt==
  cat ~/.ssh/id_rsa.pub | ssh root@192.168.5.1 'cat >> /etc/dropbear/authorized_keys'
or
  cat ~/.ssh/id_rsa.pub | ssh wifibox 'cat >> /etc/dropbear/authorized_keys'
  
after that it easy to scp files without entering passwords.
  scp /Users/rick/Documents/Doodle3D/3dprintserver/doodle3d-firmware/src/rest/api/api_sketch.lua wifibox:/usr/share/lua/wifibox/rest/api

==scp file when local file changes==
[[http://superuser.com/questions/181517/how-to-execute-a-command-whenever-a-file-changes|source]]
<code bash>
#!/bin/bash

while true    
do
   ATIME=`stat -f %Z $1`

   #echo $ATIME --- $LTIME
   if [[ "$ATIME" != "$LTIME" ]]
   then    
       echo "scp $1 $2"
       scp $1 $2
       LTIME=$ATIME
   fi
   sleep 1
done
</code>

==building==
* http://www.doodle3d.com/help/wiki/building-openwrt-wifibox

==error building package==
<code>
make[3]: *** No targets specified and no makefile found.  Stop.
make[2]: *** [/Volumes/OpenWRT/trunk/build_dir/target-mips_34kc_uClibc-0.9.33.2/bell/.built] Error 2
make[2]: Leaving directory `/Users/rick/Documents/VechtclubXL/door-bell'
make[1]: *** [package/feeds/bell/door-bell/compile] Error 2
make[1]: Leaving directory `/Volumes/OpenWRT/trunk'
</code>
in our case the folder-name containing the package did not match the package name.

==while adding packages: Ignoring feed 'bell' - index missing==
solution:
  ./scripts/feeds update -a
instead of:
  ./scripts/feeds update

==tip van Ruben over mr3020==
* http://www.linux-magazine.com/Online/Features/The-One-Watt-Server

==opkg update fails==
<code>
~# opkg update
Downloading http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/Packages.gz.
wget: server returned error: HTTP/1.1 404 Not Found
Collected errors:
* opkg_download: Failed to download http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/Packages.gz, wget returned 1.
</code>
solution:
In a live Openwrt system, the last lines in /etc/opkg.conf should be:
<code>
src/gz chaos_calmer_base http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/base
src/gz chaos_calmer_luci http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/luci
src/gz chaos_calmer_management http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/management
src/gz chaos_calmer_packages http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/packages
src/gz chaos_calmer_routing http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/routing
src/gz chaos_calmer_telephony http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/telephony
</code>
instead of that one line  src/gz something
  http://downloads.openwrt.org/snapshots/trunk/ar71xx/packages/Packages.gz  )

(from: https://forum.openwrt.org/viewtopic.php?pid=243637#p243637)

==controlling LEDs through GPIO==
  cd /sys/class/leds/tp-link\:green\:3g/
  echo 1 > brightness
  #echo 0 > brightness
  
==wifi repeater==
https://forum.openwrt.org/viewtopic.php?id=39077

==Cross-compile==
* http://wiki.openwrt.org/doc/devel/crosscompile

==Hidden Sound System==
<code html>
...
 <li><a href="javascript:play('http://pr128.pinguinradio.nl:80/')">Pinguin Radio</a>
...
<script>
function play(url) {
  get("/cgi-bin/play?url="+url);
}

function stop() {
  get("cgi-bin/stop");
}

function get(url) {
  var xmlhttp = new XMLHttpRequest();
  xmlhttp.open("GET", url, false);
  xmlhttp.send();
}
</script>
</code>

''edit.html''
<code html>

<html>
<body>
<style>
  textarea {
    width: 100%;
    height: 90%;
    font-family: monospace;
    font-size: 1em;
  }
</style>

<form action="cgi-bin/save" method="POST">
<input type="submit" value="Save">
<input type="button" value="Cancel" onclick="location.href='/'">
<textarea id="txt" name="txt"></textarea>
</form>

<script>
var xmlhttp, text;
xmlhttp = new XMLHttpRequest();
xmlhttp.open('GET', 'index.html?'+Math.random(), false);
xmlhttp.send();
document.getElementById('txt').value = xmlhttp.responseText;
</script>

</body>
</html>
</code>

''cgi-bin/play:''
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
killall madplay -q
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
url=`uhttpd -d $url`
wget -O - $url | madplay - & 
echo "ok"
echo ""
echo ""
</code>

''cgi-bin/save''
<code bash>
#!/bin/sh
#echo "Content-type: text/plain"
#echo ""
read QUERY_STRING
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')
cp index.html index.bak
uhttpd -d $txt > index.html
#cat index.html
echo "Status: 301 Moved"           
echo "Location: /"                   
echo ""                            
echo ""
</code>

''stop''
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
killall madplay -q
echo ""
echo ""
</code>

==FAT-fs (sda1): IO charset iso8859-1 not found (while mounting a usb device)==
<code>
/sbin/insmod nls_iso8859-1
</code>

==environment variables including hostname in cgi-bin==
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
export                                                              
echo ""                                                             
echo ""  
</code>

==uci==
<code>
uci show
</code>

==create a dumb AP==
* http://wiki.openwrt.org/doc/recipes/dumbap
<code>
#/etc/config/network
...
config interface lan
        option type     'bridge'
        option ifname   'eth0 eth1'
        option proto    'dhcp'
</code>
<code>
#/etc/config/wireless
...
config wifi-iface
        option device   radio0
        option network  lan
        option mode     ap
        option ssid     OpenWrt
        option encryption none
</code>

==authorized keys instructions with dropbear==
* put your public key string in '''/etc/dropbear/authorized_keys'''

==AirPlay on the MR3020==
* http://www.dlemper.de/index.php/2012/12/29/airplay-server-on-tp-link-mr3020/
* [[https://nzlamb.wordpress.com/2013/05/19/openwrt-airplay-server-on-hp-thin-terminal/|more info]]
==uci on ubuntu==
http://www.wakoond.hu/2013/06/using-uci-on-ubuntu.html

==usb over IP==
http://wiki.openwrt.org/doc/howto/usb.iptunnel

==carambola==
http://shop.8devices.com/carambola

==TP-Link wr702n==
draait geen OpenWrt maar kan wel als Arduino shield gebruikt worden:
http://hackanerd.wordpress.com/2013/07/06/how-to-make-a-simple-arduino-wireless-shield/

==cgi-bin read GET QueryString==
<code>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
#echo $QUERY_STRING     
#read QUERY_STRING                                                      
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}') 
#txtOutput=`uhttpd -d $b`         
echo $b > /dev/ttyACM0
echo ""
echo ""
</code>

==arduino connected to internal serial port==
http://www.martinmelchior.be/2013/07/use-tp-link-tl-wr703n-to-send-arduino.html?m=1

==wifi settings==
/etc/config/wireless:
<code>
config wifi-device  radio1
	option type     mac80211
	option channel  11
	option macaddr	ec:88:8f:dc:c6:4e
	option hwmode	11ng
	option htmode	HT20
	list ht_capab	SHORT-GI-20
	list ht_capab	SHORT-GI-40
	list ht_capab	RX-STBC1
	list ht_capab	DSSS_CCK-40

config wifi-iface
	option device   radio1
	option network  wan
	option mode     sta
	option ssid     Globe4D
	option encryption psk2
	option key	.........
</code>

==toggle USB power on MR3020==
<code>
ON: echo 1 >/sys/class/gpio/gpio8/value
OFF: echo 0 >/sys/class/gpio/gpio8/value
</code>

==voip on openwrt==
* the packages sipp & sipsak for OpenWRT
* http://wiki.openwrt.org/doc/howto/voip.asterisk
* http://wiki.openwrt.org/doc/howto/voip.overview
* http://sourceforge.net/projects/sipath/
* http://gonedigital.net/2014/01/07/sipgate-asterisk-and-openwrt/

==opencv on openwrt==
* http://mark4h.blogspot.nl/2013/04/cross-compiling-opencv-for-openwrt.html

==wisp==
* https://bitbucket.org/pklaus/openwrt-configurations/src/f4bfd4355163/TP-Link_TL-MR3020/WISP/?at=master

==dit nog uitproberen:==
* http://thismachinechills.blogspot.nl/2013/02/building-openwrt-on-mac-os-x.html
* http://thismachinechills.blogspot.nl/2013/02/modifying-openwrt-trunk-for-compilation.html

==flash existing openwrt install from remote==
create a shell script:
<code bash>
if [ $# -eq 1 ]; then
	IMAGE=$1
	FILENAME=`basename $IMAGE`
	scp $IMAGE root@wifibox:/tmp
	ssh -t root@wifibox "sysupgrade -v -n /tmp/$FILENAME"
fi 
</code>

==restart uhttpd==
<code bash>/etc/init.d/uhttpd restart</code>

==scp a doodle3d file to the box==
<code bash>
scp /Users/rick/Documents/Doodle3D/3dprintserver/doodle3d-firmware/src/conf_defaults.lua wifibox:/usr/share/lua/wifibox/
scp /Users/rick/Documents/Doodle3D/3dprintserver/doodle3d-firmware/src/util/* wifibox:/usr/share/lua/wifibox/util/
</code>

==stop a (doodle3d) process and start manually in verbose mode==
<code>
/etc/init.d/print3d stop
print3d -v
</code>

==updating firmware==
local: 
<code>
scp openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-sysupgrade.bin root@192.168.5.1:/tmp
</code>
remote:
<code>
mtd -r write openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-sysupgrade.b
in firmware
</code>

==usb over IP==
check if this works:
http://www.madox.net/blog/2013/01/04/tl-wr703n-example-project-3-wireless-3d-printing-or-2d-printing-or-just-simply-wireless-usb/

==save contents of form variable to file in /tmp==
/www/index.html
<code html>
<form method="post" action="cgi-bin/save.sh">
<textarea name="txtOutput" rows=50 cols=100></textarea>
<input type="submit">
</form>
</code>

/www/cgi-bin/save.sh
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
read QUERY_STRING
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')

txtOutput=`uhttpd -d $txtOutput`
echo $txtOutput > /tmp/file.txt

echo ""
echo ""
</code>

==automatic install OpenWrt firmware on TPLink MR3020==
* http://wiki.openwrt.org/toh/tp-link/tl-mr3020#oem.mass.flashing

==restore original MR3020 firmware==
* http://wiki.openwrt.org/toh/tp-link/tl-mr3020#restoring.original.firmware
* (http://ediy.com.my/index.php/blog/item/51-tp-link-tl-mr3020-restore-from-openwrt-to-original-firmware)

==get mac address==
<code>
ifconfig wlan0 | awk '/HWaddr/ { print $5 }'
</code>

==replace dropbear by open-ssh-server==
* http://wiki.openwrt.org/inbox/replacingdropbearbyopensshserver

==mount usb disk on startup==
* http://wiki.openwrt.org/doc/uci/fstab

in /etc/config/fstab
<code>
config 'mount'
        option 'target'   '/mnt'
        option 'device'   '/dev/sda1'
        option 'fstype'   'ext2'
        option 'enabled'  '1'
        option 'enabled_fsck' '0'
</code>

==on osx to prepare a ext2 usbstick==
<code>
locate mke2fs
diskutil list
diskutil unmount /dev/disk{...}
mke2fs /dev/disk{...}
mkfs.ext2 /dev/disk{...}
</code>
(not tested: or install ''http://garr.dl.sourceforge.net/project/fuse-ext2/fuse-ext2/fuse-ext2-0.0.7/fuse-ext2-0.0.7.dmg'' and use the Mac OSX Disk Utility to erase the usb-drive using fuse-ext2)


==logread==
follow log file
<code>
logread -f
</code>

==network/wireless config files gemaakt op ohm2013==
/etc/config/network
<code>
config interface 'loopback'
option ifname 'lo'
option proto 'static'
option ipaddr '127.0.0.1'
option netmask '255.0.0.0'

config interface 'lan'
option ifname 'eth0'
option type 'bridge'
option proto 'static'
option netmask '255.255.255.0'
option ipaddr '192.168.3.1'

config interface 'wan'
option _orig_ifname 'wlan0'
option _orig_bridge 'false'
option proto 'dhcp'
</code>

/etc/config/wireless
<code>
config wifi-device  radio1
	option type     mac80211
	option channel  11
	option hwmode	11ng
	option path	'platform/ar933x_wmac'
	option htmode	HT20
	list ht_capab	SHORT-GI-20
	list ht_capab	SHORT-GI-40
	list ht_capab	RX-STBC1
	list ht_capab	DSSS_CCK-40
	# REMOVE THIS LINE TO ENABLE WIFI:
#	option disabled 1

config wifi-iface
	option device   radio1
	option network  wan
	option mode     sta
	option ssid     OHM2013
	option proto	dhcp
	option encryption none
</code>

==start up script==
not finished....
<code bash>
#!/bin/sh /etc/rc.common
START=99
start() {
        /Doodle3D/Doodle3D > /dev/null 2> /dev/null &
}
</code>

==enable wireless==
By default the wireless is OFF. You can turn it on in the /etc/config/wireless by changing disabled 1 to disabled 0
In UCI CLI you do this with:
<code bash>
uci set wireless.@wifi-device[0].disabled=0; uci commit wireless; wifi
</code>

==scan script==
<code bash>
ifconfig wlan0 down
iw phy phy0 interface add scan0 type station
ifconfig scan0 up
iwlist scan0 scan | grep ESSID  | cut -c 27- | tr -d '"'
iw dev scan0 del
ifconfig wlan0 up
</code>

==connect script==
<code bash>
uci set wireless.@wifi-iface[0].ssid=$1
uci set wireless.@wifi-iface[0].encryption=$2
uci set wireless.@wifi-iface[0].key=$3
uci set wireless.@wifi-iface[0].mode=sta
uci set wireless.@wifi-iface[0].network=wan
uci commit wireless
wifi
</code>

==accesspoint script==
<code bash>
uci set wireless.@wifi-iface[0].ssid=Doodle3D
uci set wireless.@wifi-iface[0].encryption=none
uci set wireless.@wifi-iface[0].key=''
uci set wireless.@wifi-iface[0].mode=ap
uci set wireless.@wifi-iface[0].network=lan
uci commit wireless
wifi
</code>

==scan for wireless networks==
* http://wiki.openwrt.org/doc/faq/faq.wireless#how.to.scan.for.wireless.networks

==Failsafe mode==
* http://wiki.openwrt.org/doc/howto/generic.failsafe
- take a fixed ip on your computer: 192.168.1.2 (mask: 255.255.255.0)
- Power on device
- Wait for blinking led
- Press reset -> led flashes like crazy
- wait a minute
- telnet 192.168.1.1
- you're in.
<code bash>
mount_root
passwd
</code>
to find out your ip:
<code bash>
uci get network.lan.ipaddr
</code>
* more info: http://wiki.openwrt.org/doc/howto/generic.failsafe#in.failsafe.mode

==Regenerate Wireless Configuration==
To rebuild the configuration file, e.g. after installing a new wireless driver, remove the existing wireless configuration (if any) and use the wifi detect command with stdout redirected to the /etc/config/wireless file:

<code>
rm -f /etc/config/wireless
wifi detect > /etc/config/wireless
</code>

==bootstrap skin for OpenWrt by nut&bolt==
* download and install the 'luci-theme-bootstrap' package

==press for connect==
* [[http://github.com/nutbolt/press4connect|press4connect]] (work in progress)

==uci==
* http://wiki.openwrt.org/doc/uci
* http://wiki.openwrt.org/doc/uci/network
* http://wiki.openwrt.org/doc/uci/wireless
more from [[https://code.google.com/p/afrimesh/wiki/HowToBatmanAdvanced|batman]]
<code>
uci delete wireless.wifi0.disabled
uci delete wireless.@wifi-iface[0].network
uci set wireless.wifi0.channel=1
uci set wireless.@wifi-iface[0].mode=adhoc
uci set wireless.@wifi-iface[0].ssid=afrimesh
uci set network.lan.mtu=1500
uci set network.lan.ifname="eth0 bat0"
uci set network.lan.proto=dhcp
uci delete network.lan.ipaddr
uci delete network.lan.netmask
uci set network.wifi0=interface
uci set network.wifi0.ifname=ath0
uci set network.wifi0.proto=none
#uci set network.wifi0.mtu=1524
uci set network.wifi0.mtu=1548
uci set network.bat0=interface
uci set network.bat0.ifname=bat0
uci set network.bat0.proto=none
uci set network.bat0.mtu=1500
uci set batman-adv.bat0.interfaces=ath0
uci commit
</code>

==forward all DNS traffic to device==
/etc/config/dhcp
<code>
list address            '/#/192.168.3.1'
</code>

<code>
uci add_list dhcp.@dnsmasq[0].address='/#/1.0.0.1'
uci commit dhcp
</code>

==wifi scan and show in list==
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
iwlist wlan0 scan | grep ESSID  | cut -c 27- | tr -d '"'
</code>

<code html>
<html>
<head>
  <title>Doodle3D</title>
  <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>

  <script>
  $(document).ready(function(){
    $.get("cgi-bin/wifi-scan", function(data) {
      data = data.split("\n");
      console.log(data.length);
      var options = $("#boxNetwork");
      options.empty();
      $.each(data, function(index,value) {
        console.log(value);
	if (value!="") options.append($("<option />").val(value).text(value));
      });
   });
  });
  </script>
</head>

<body>

	<select id="boxNetwork">
		<option value="" disabled selected>Scanning for neworks...</option>
	</select>
	<input id="txtPassword" placeholder="password" value="" type="password">
	<input id="btnConnect" type="button" value="Connect">

</body>
</html>
</code>

==cross compile on Mac==
Create case sensitive HFS:
<code bash>
hdiutil create -size 15g -fs "Case-sensitive HFS+" -volname OpenWRT ~/OpenWRT.sparsebundle
hdiutil attach OpenWRT.sparsebundle 
</code>
Checkout OpenWRT source:
<code bash>
cd /Volumes/OpenWRT && svn co svn://svn.openwrt.org/openwrt/trunk/;
</code>
Run 'feeds update' script:
<code bash>
cd trunk; scripts/feeds update -a
</code>
selfupdate & subversion
<code>
sudo port -v selfupdate; sudo port install subversion
</code>
install dependencies:
<code bash>
sudo port install coreutils e2fsprogs ossp-uuid asciidoc binutils bzip2 fastjar flex getopt gtk2 intltool jikes \ zlib openssl p5-extutils-makemaker python26 rsync ruby sdcc unzip gettext libxslt bison gawk autoconf wget \ gmake ncurses findutils
</code>
make menu
<code>
make prereq; make defconfig; make menuconfig
</code>
install everything for cross-compiler...
<code>
make V=s
</code>

==mr3020==
http://wolfgang.reutz.at/2012/04/12/openwrt-on-tp-link-mr3020-as-infopoint-with-local-webserver/

==reading and writing config values through uci (recommended)==
<code>
uci get wireless.@wifi-iface[0].key
uci set wireless.@wifi-iface[0].key=YOURKEY
</code>

<code>
uci set wireless.radio0.channel=$wifichannel
uci set wireless.wificlient.ssid="$wifissid"
uci set wireless.wificlient.encryption=$wifimode
uci set wireless.wificlient.key=$wifipass
uci commit wireless
wifi down
wifi
</code>

==how to debrick==
* http://wiki.openwrt.org/doc/howto/generic.debrick

==show login intro text==
<code>cat /etc/banner</code>

==How do I access the syslog messages?==
<code> logread</code>

==list connected dhcp clients==
<code>cat /tmp/dhcp.leases</code>

==hotplug==
http://wiki.openwrt.org/doc/techref/hotplug

==scan for wifi networks==
<code>iwlist wlan0 scan | grep ESSID  | cut -c 27- | tr -d '"'</code>

==get current wifi configuration==
<code>iwconfig wlan0</code>

==ideale setup voor doodle3d box zou zijn==
- eerst proberen te verbinden met een het laatst verbonden netwerk
- als die niet beschikbaar is dan proberen te verbinden met vorige etc.
- als geen enkel netwerk zichtbaar is dan zelf een AP starten waarmee in een vriendelijke webpagina (die automatisch toont via dns route) gescand kan worden naar beschikbare netwerken.

==uci==
http://wiki.openwrt.org/doc/uci

==tips==
* http://cmikavac.net/2012/06/03/tp-link-wr703n-openwrt-post-installation-tips/
* http://mattventura.net/2009/08/17/a-mostly-complete-openwrt-tutorial/
* http://www.macfreek.nl/memory/OpenWRT_Network_Configuration

==network restart==
<code>
/etc/init.d/network restart
</code>

==settings with cat==
<code>
telnet 192.168.1.1


cat<<EOF>/etc/config/network
config interface 'loopback'
	option ifname 'lo'
	option proto 'static'
	option ipaddr '127.0.0.1'
	option netmask '255.0.0.0'

config interface 'lan'
	option ifname 'eth0'
	option type 'bridge'
	option proto 'static'
	option netmask '255.255.255.0'
	option ipaddr '192.168.3.1'

config interface 'wan'
	option _orig_ifname 'wlan0'
	option _orig_bridge 'false'
	option proto 'dhcp'
EOF

cat<<EOF>/etc/config/wireless
config wifi-device 'radio0'
	option type 'mac80211'
	option channel '11'
	option macaddr 'ec:88:8f:c6:10:a6'
	option hwmode '11ng'
	option htmode 'HT20'
	list ht_capab 'SHORT-GI-20'
	list ht_capab 'SHORT-GI-40'
	list ht_capab 'RX-STBC1'
	list ht_capab 'DSSS_CCK-40'
	option txpower '27'
	option country 'US'

config wifi-iface
	option device 'radio0'
	option mode 'sta'
	option ssid 'Blendid'
	option encryption 'psk2'
	option key '...................................'
	option network 'wan'
EOF
</code>


==cat <<==
<code>
cat << EOM >> tmp.txt
.... paste text here
EOM
</code>

==getting started==
*http://wiki.xinchejian.com/wiki/Install_OpenWRT_on_TPlink_WR703N

==running in wifi client mode==
''/etc/config/network''
<code>
config interface 'wan'
        option ifname 'wlan0'
        option proto 'dhcp'
</code>

''/etc/config/wireless''
<code>
...
config wifi-iface                  
        option device radio0 
        option network wan   
        option mode sta      
        option ssid ...
        option encryption psk2
        #or psk instead of psk2
        option key ....
</code>

==scan for wifi networks==
<code>iwlist scanning</code>
<code>iwlist wlan0 scan</code>

==sftp==
* http://wiki.openwrt.org/doc/howto/sshfs.server
* http://wiki.openwrt.org/inbox/replacingdropbearbyopensshserver

==useful wiki by acemonstertoys==
* http://wiki.acemonstertoys.org/Tp-link_router

==list serial devices==
<code>
ls -1 /dev/ttyACM*
</code>

==process ID==
<code>
echo $$
</code>

==cgi==
* http://wiki.openwrt.org/doc/howto/http.httpd
<code bash>
#!/bin/sh
echo "Content-type: text/html"
echo ""
echo "Sample CGI Output"
echo ""
echo ""
env
echo ""
echo ""
</code>

==cgi script extracting POST variables==
<code bash>
#!/bin/sh
echo "Content-type: text/plain"
echo ""
#???? read QUERY_STRING
eval $(echo "$QUERY_STRING"|awk -F'&' '{for(i=1;i<=NF;i++){print $i}}')

#escaped
#echo $txtOutput

#unescaped
txtOutput=`uhttpd -d $txtOutput`
echo $txtOutput
</code>

==serial port==
Alleen ''opkg install kmod-usb-acm'' lijkt nodig.

*http://wiki.acemonstertoys.org/Tp-link_router
*http://lectroleevin.wordpress.com/2011/10/26/arduino-openwrt-usb-connection/
<code bash>
opkg update
opkg install coreutils-stty 
opkg install kmod-usb-serial
opkg install kmod-usb-serial-ftdi
#opkg install kmod-usb-serial-cp210x 
opkg list | grep -i acm
kmod-usb-acm - 2.6.32.16-1 - Kernel support for USB ACM devices (modems/isdn controllers)
opkg install kmod-usb-serial
opkg install coreutils-stty 
opkg install kmod-usb-acm
</code>
By default everything that comes to WR703N serial port is echoed back. 
If you also want to send commands to Arduino, the buffer will be full with echoed data. 
Need to set no echo option in sstty. 
<code>/usr/bin/stty -F /dev/ttyACM0 raw speed 115200 -echo</code>

Arduino is reset every time it is read by command "head"
To disable reset by DTR pin add option to stty 
<code>-hupcl</code>

<code>
/usr/bin/stty -F /dev/ttyACM0 raw speed 115200 -echo
cat /dev/ttyACM0
</code>

==sh scripting for serial==
<code bash>
#!/bin/sh                                                                    
echo "Content-type: text/html"                                               
echo ""                                                                      
echo "test"                                                                  
                                                                             
PORT=/dev/ttyACM1                                                            
                                                                             
if  [ -c $PORT ]; then                                                       
      /usr/bin/stty -F $PORT raw speed 115200 -echo -hupcl                   
      while [ 1 ]; do                                                        
              if [ -c $PORT ]; then                                          
                      head -n 8 $PORT                                        
                      sleep 1                                                
              else                                                           
                      # USB dissapeared.                                     
                      echo "Arduino no longer attached"                      
                      exit                                                   
              fi                                                             
      done                                                                   
  else                                                                       
      echo "Arduino not attached"                                            
  fi                                                                         
fi 
</code>

==disk usage==
<code>
du * -sh
</code>

==symbolic link from www folder to /mnt==
<code>
ln -s /mnt/jquery.mobile-1.0.1 www2
</code>

==install opkg packages on usb-stick==
*http://wiki.openwrt.org/doc/recipes/install.packages.on.usb-stick
add <code>dest usb /mnt/</code> to <code>/etc/opkg.conf</code>
<code>
export USB=/mnt
export PATH=$PATH:$USB/usr/bin:$USB/usr/sbin
export LD_LIBRARY_PATH=$USB/lib:$USB/usr/lib
#####
opkg install unzip -d usb
</code>

==compilen vanaf windows of linux voor openwrt==
*[[http://www.mentor.com/embedded-software/downloads/|Sourcery CodeBench Lite Edition]]

==scp (secure copy)==
scp from to
<code>
scp jquery.mobile-1.0.1.zip root@192.168.1.47:/mnt/ 
</code>

==create large file with zeros (10MB)==
<code>
dd if=/dev/zero of=/mnt/largefile bs=1024 count=10240
</code>

==usb storage==
http://wiki.openwrt.org/doc/howto/usb.storage
<code>
opkg install kmod-usb-storage block-mount kmod-fs-vfat  kmod-nls-cp437 kmod-nls-iso8859-1 
mount /dev/sda1 /mnt
</code>

==mount==
<code>
mount
</code>

==writable permanent store==
<code>
/overlay
</code>

==for humans diskfree info==
<code>
df -h
</code>

==/proc/==
bevat textfiles met info over je systeem zoals <code>cat /proc/filesystems </code>

==mount usb drive==
<code>

</code>

==flush firewall settings==
<code>
iptables -F
</code>
<code>
iptables -L
</code>
check INPUT, OUTPUT, FORWARD

==captive portals==
* http://en.wikipedia.org/wiki/Captive_portal
* http://wiki.openwrt.org/doc/howto/wireless.hotspot.wifidog
* https://forum.openwrt.org/viewtopic.php?id=11536
* http://www.authpuppy.org/
* http://dev.wifidog.org/wiki/doc/install/gateway

==various==
<code>
opkg update
opkg install openssh-sftp-server
</code>

* ??? <code>gcom info -d /dev/ttyUSBx</code>

*http://www.minipwner.com/index.php/forum/4-community-edition-installation/109-no-space-left-on-device

* use '''kmod-usb-storage''' for usb drive support

* config
<code>
/etc/config/network
</code>

==cross compiling==
using Sourcery_CodeBench_Lite_for_MIPS_GNU_Linux on Windows
<code>
 mips-linux-gnu-gcc -static -s -msoft-float -muclibc hello.c -o hello
</code>